<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tiered Revshare Calculator — Step Explorer (v3.8)</title>
  <style>
    :root {
      --bg:#0f1220; --panel:#171a2b; --muted:#8a93a6; --text:#e8ecf8; --accent:#7aa2ff;
      --green:#5fd08b; --yellow:#ffd166; --purple:#b388ff; --track:#0e1325;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; padding:24px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, #1d2342 0%, #0f1220 60%);
      color: var(--text);
    }
    h1 { margin: 0 0 8px; font-weight: 700; letter-spacing: 0.2px; }
    .sub { color: var(--muted); margin-bottom: 24px; }
    .wrap { display:grid; grid-template-columns: 420px 1fr; gap: 20px; align-items:start; }
    .card { background: linear-gradient(180deg,#1a2040, #151a30); border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .stack { display:flex; flex-direction:column; gap: 14px; }
    .row { display:grid; grid-template-columns: 1fr 200px; gap: 12px; align-items:center; }
    .row label { color: var(--muted); font-size: 14px; }
    input[type="text"]{
      width: 100%; padding: 14px 14px; border-radius: 12px; background: #0e1325; color: var(--text);
      border: 1px solid rgba(255,255,255,.10); outline: none; font-size: 18px; font-weight: 600;
    }
    input[type="range"]{ width: 100%; height: 36px; }
    .muted { color: var(--muted); }
    .badge { display:inline-block; padding:6px 12px; border-radius:999px; background:#0e1325; border:1px solid rgba(255,255,255,.10); font-size:13px; color: var(--muted); }
    .bar { display:flex; height: 30px; overflow:hidden; border-radius: 999px; background: #0e1325; border:1px solid rgba(255,255,255,.08); }
    .bar .your { background: var(--purple); display:flex; align-items:center; justify-content:center; font-size:13px; }
    .bar .client { background: var(--green); display:flex; align-items:center; justify-content:center; font-size:13px; flex:1; }
    .grid { width: 100%; border-collapse: collapse; }
    .grid th, .grid td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 14px; }
    .grid th { text-align:left; color: var(--muted); font-weight: 700; }
    .grid tr.highlight { background: rgba(122,162,255,.18); }
    .grid tr:hover { background: rgba(122,162,255,.10); cursor: pointer; }

    /* Step Explorer */
    .dual-track { position: relative; height: 76px; padding: 22px 14px; background: var(--track); border-radius: 14px;
      border:1px solid rgba(255,255,255,.08); user-select:none; }
    .dual-track .rail { position:absolute; top:34px; left:14px; right:14px; height:10px; background:#1c2444; border-radius:999px; }
    .dual-track .ticks { position:absolute; top:28px; left:14px; right:14px; height:22px; display:flex; justify-content:space-between; pointer-events:none; }
    .dual-track .ticks span { width:2px; height:22px; background:rgba(255,255,255,.12); }
    .dual-track .rail .fill { position:absolute; top:0; height:10px; background: linear-gradient(90deg, #ffd166, #7aa2ff); border-radius:999px; }
    .thumb { position:absolute; top:26px; width:24px; height:24px; border-radius:50%; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.35); cursor:grab; }
    .thumb:active { cursor:grabbing; }
    .thumb.start { background:#ffd166; }
    .thumb.current { background:#7aa2ff; }

    canvas { width: 100%; height: 260px; background:#0f1328; border-radius: 12px; border:1px solid rgba(255,255,255,.08); }
    .note { font-size: 13px; color: var(--muted); }

    /* Inventory slider with labels */
    .inv-wrap { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; }
    .inv-labels { display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-top:-8px; }

    /* Accumulated Totals */
    .accum { margin-top: 6px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10); }
    .accum h3 { margin:0 0 6px; font-size:14px; color:var(--muted); font-weight:700; }
    .accum .line { display:flex; justify-content:space-between; margin: 2px 0; }
    .accum .val { font-weight:800; }
  </style>
</head>
<body>
  <h1>Tiered Revshare Calculator</h1>
  <div class="sub">T (Annual Target Revenue) defines the <em>first step</em> (band size). <strong>This tool shows the marginal share for the selected band only</strong>, and the left panel shows <strong>accumulated totals</strong> up to that band.</div>

  <div class="wrap">
    <!-- LEFT: Inputs -->
    <div class="card stack">
      <div class="row">
        <label for="target">Annual Target Revenue (band size, T)</label>
        <input id="target" type="text" value="$200,000">
      </div>

      <!-- Inventory slider 25% jumps -->
      <div class="stack">
        <div class="inv-wrap">
          <label for="invSlider" id="invLabel">Inventory Exposure</label>
          <div class="badge"><span id="invDisplay">25</span>%</div>
        </div>
        <input id="invSlider" type="range" min="25" max="100" step="25" value="25">
        <div class="inv-labels"><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div>
      </div>

      <div class="note" id="noticeBox"></div>

      <!-- Accumulated Totals -->
      <div class="accum" id="accumTotals">
        <h3>Accumulated totals (to selected band)</h3>
        <div class="line"><span>Gross</span><span class="val" id="accGross">$0</span></div>
        <div class="line"><span>Your total</span><span class="val" id="accYour">$0</span></div>
        <div class="line"><span>Client total</span><span class="val" id="accClient">$0</span></div>
        <div class="line"><span>Your effective %</span><span class="val" id="accEff">0%</span></div>
      </div>
    </div>

    <!-- RIGHT: Results -->
    <div class="card stack">
      <!-- Step Explorer -->
      <div class="stack">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="muted">Step Explorer (per-step, step-locked)</div>
          <div class="badge">Band width: <span id="bandWidth">$0</span></div>
        </div>
        <div class="dual-track" id="dualTrack">
          <div class="rail" id="rail"><div class="fill" id="fill"></div></div>
          <div class="ticks" id="ticks"></div>
          <div class="thumb start" id="thumbStart" title="Band Start"></div>
          <div class="thumb current" id="thumbCurrent" title="Band End"></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:13px;" class="muted">
          <div>Selected band: <span id="stepLabel">0</span> (rate: <span id="stepRate">0%</span>)</div>
          <div>Range: <span id="stepRange">$0 – $0</span></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <div class="muted">Your Share (This Band)</div>
          <div id="yourValue" style="font-size:22px; font-weight:800;">$0</div>
        </div>
        <div>
          <div class="muted">Client Share (This Band)</div>
          <div id="clientValue" style="font-size:22px; font-weight:800;">$0</div>
        </div>
      </div>
      <div class="bar">
        <div id="yourBar" class="your" style="width:0%;">Your 0%</div>
        <div id="clientBar" class="client">Client 100%</div>
      </div>

      <!-- Discount Chart -->
      <div class="stack">
        <div class="muted">Per-step discount from 50% (current inventory)</div>
        <canvas id="discountChart" width="900" height="260"></canvas>
      </div>
    </div>
  </div>

  <!-- LOOKUP TABLE -->
  <div class="card" style="margin-top:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div class="muted">Lookup table (per-step platform % by inventory). Click a row to select the band.</div>
      <!-- label removed per request -->
    </div>
    <table class="grid" id="lookup">
      <thead>
        <tr>
          <th>Revenue Band (by T)</th>
          <th>25%</th><th>50%</th><th>75%</th><th>100%</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      BANDS: 5,                 // exactly 5 finite bands: 0..4
      MIN_INVENTORY_PCT: 25,
      MAX_INVENTORY_PCT: 100,
      BASE_MAX_SHARE_PCT: 50,
      PER_STEP_BASE: 1.0,
      BAND_ACCEL: 0.25,
      INV_ACCEL: 1.1,           // softened
      INVENTORY_DENOM: 150,     // softened
      UI_MAX_STEPS: 5,          // slider snaps to these 5 bands
      // Discount shaping (conservative)
      GLOBAL_CAP: 60,           // absolute cap for discount (%)
      ALPHA_INV: 1.1,           // inventory exponent
      BETA_STEP: 1.3,           // step exponent
      K_MIN: 0.7,               // log k lower bound
      K_MAX: 1.4,               // log k upper bound,
      STEP_MULT_EXP: 1.1        // step sensitivity for post-reduction inventory multiplier
    };
    const clamp = (v, lo, hi) => Math.min(Math.max(v, lo), hi);
    const onlyDigits = s => (s||'').replace(/[^\d]/g, '');

    function totalStepReduction(step, icp, cfg = CONFIG) {
      const invScale = clamp((icp - cfg.MIN_INVENTORY_PCT) / (cfg.MAX_INVENTORY_PCT - cfg.MIN_INVENTORY_PCT), 0, 1);
      const bandTerm = cfg.PER_STEP_BASE * (1 + cfg.BAND_ACCEL * Math.max(step - 1, 0));
      return step * bandTerm * (1 + cfg.INV_ACCEL * invScale);
    }

    function shapeDiscount(rawDiscount, step, icp, cfg=CONFIG){
      const sClamped = clamp(step, 0, cfg.BANDS-1);
      const fStep = Math.pow(sClamped / (cfg.BANDS-1), cfg.BETA_STEP);
      const fInv  = Math.pow((icp - cfg.MIN_INVENTORY_PCT) / (cfg.MAX_INVENTORY_PCT - cfg.MIN_INVENTORY_PCT), cfg.ALPHA_INV);
      let desiredCap = cfg.GLOBAL_CAP * clamp(0.15 + 0.85 * (0.35*fInv + 0.65*fStep), 0, 1);
      let k = cfg.K_MIN + (cfg.K_MAX - cfg.K_MIN) * clamp(0.25*fInv + 0.75*fStep, 0, 1);
      const x = clamp(rawDiscount, 0, desiredCap);
      const y = desiredCap * (1 - Math.exp(-k * (x / desiredCap)));
      return clamp(y, 0, desiredCap);
    }

    function bandPercent(step, icp, cfg = CONFIG) {
      if (step === 0 && icp <= 25) return cfg.BASE_MAX_SHARE_PCT; // 50/50 for first band at 25%
      const pre = Math.max(0, cfg.BASE_MAX_SHARE_PCT - totalStepReduction(step, icp, cfg));
      const fStep = Math.pow(clamp(step,0,cfg.BANDS-1) / (cfg.BANDS-1), cfg.STEP_MULT_EXP);
      const multiplier = Math.max(0, 1 - (icp / cfg.INVENTORY_DENOM) * (0.6 + 0.4*fStep));
      const rawPlatform = Math.max(0, pre * multiplier);
      const rawDiscount = cfg.BASE_MAX_SHARE_PCT - rawPlatform;
      const adjDiscount = shapeDiscount(rawDiscount, step, icp, cfg);
      const platform = clamp(cfg.BASE_MAX_SHARE_PCT - adjDiscount, 0.5, cfg.BASE_MAX_SHARE_PCT); // never 0%
      return platform;
    }

    // UI helpers
    function fmt(n){ return '$' + Math.round(n).toLocaleString(); }
    function humanShort(n){
      if (n >= 1e9) return (n/1e9).toFixed(n%1e9===0?0:1) + 'B';
      if (n >= 1e6) return (n/1e6).toFixed(n%1e6===0?0:1) + 'M';
      if (n >= 1e3) return (n/1e3).toFixed(n%1e3===0?0:1) + 'K';
      return String(n);
    }
    function onlyDigitsCurrency(s){ return (s||'').replace(/[^\d]/g,''); }
    function formatCurrencyInput(el){
      const raw = onlyDigitsCurrency(el.value);
      const n = raw ? parseInt(raw,10) : 0;
      el.value = '$' + n.toLocaleString();
      return n;
    }

    function bandLabel(step, T, cfg = CONFIG) {
      if (step === 0) return `≤ $${T.toLocaleString()}`;
      const lo = step * T + 1;
      const hi = (step + 1) * T;
      return `$${lo.toLocaleString()} – $${hi.toLocaleString()}`;
    }

    // ===== UI State =====
    let state = { T: 200000, inv: 25, band: 0 };
    let chartBarRects = [];

    function setupTicks(){
      const ticks = document.getElementById('ticks');
      ticks.innerHTML = '';
      for (let i = 0; i <= CONFIG.UI_MAX_STEPS; i++){
        const span = document.createElement('span');
        ticks.appendChild(span);
      }
    }
    function railMetrics(){
      const rail = document.getElementById('rail');
      const rect = rail.getBoundingClientRect();
      return { x: rect.left, w: rect.width };
    }
    function bandToPx(b){
      const { w } = railMetrics();
      const pct = Math.min(Math.max(b / CONFIG.UI_MAX_STEPS, 0), 1);
      return pct * w;
    }
    function pxToNearestBand(px){
      const { w } = railMetrics();
      const pct = Math.min(Math.max(px / w, 0), 1);
      return Math.round(pct * CONFIG.UI_MAX_STEPS);
    }
    function clampBand(b){ return Math.min(Math.max(b, 0), CONFIG.UI_MAX_STEPS-1); }

    function positionHandles(){
      const startThumb = document.getElementById('thumbStart');
      const endThumb  = document.getElementById('thumbCurrent');
      const fill = document.getElementById('fill');

      const startPx = bandToPx(state.band);
      const endPx   = bandToPx(state.band + 1);

      startThumb.style.left = (14 + startPx - 12) + 'px';
      endThumb.style.left   = (14 + endPx   - 12) + 'px';
      fill.style.left = (14 + startPx) + 'px';
      fill.style.width = Math.max(0, endPx - startPx) + 'px';

      const pct = bandPercent(state.band, state.inv).toFixed(2) + '%';
      document.getElementById('stepLabel').textContent = state.band;
      document.getElementById('stepRate').textContent = pct;
      const startAmt = state.band * state.T;
      const endAmt = (state.band + 1) * state.T;
      document.getElementById('stepRange').textContent = `${fmt(startAmt)} – ${fmt(endAmt)}`;
      document.getElementById('bandWidth').textContent = fmt(state.T);
    }

    function enableDragging(){
      const rail = document.getElementById('rail');
      const startThumb = document.getElementById('thumbStart');
      const endThumb  = document.getElementById('thumbCurrent');

      const onMoveStart = (e) => {
        const { x } = railMetrics();
        const px = (e.touches ? e.touches[0].clientX : e.clientX) - x;
        const b = clampBand(pxToNearestBand(px));
        state.band = b;
        update();
      };
      const onMoveEnd = (e) => {
        const { x } = railMetrics();
        const px = (e.touches ? e.touches[0].clientX : e.clientX) - x;
        let k = pxToNearestBand(px);
        if (k < 1) k = 1;
        if (k > CONFIG.UI_MAX_STEPS) k = CONFIG.UI_MAX_STEPS;
        state.band = clampBand(k - 1);
        update();
      };

      function drag(el, handler){
        let dragging=false;
        const down = (e)=>{ dragging=true; e.preventDefault(); };
        const up   = ()=>{ dragging=false; };
        const move = (e)=>{ if(!dragging) return; handler(e); };
        el.addEventListener('mousedown', down); window.addEventListener('mouseup', up); window.addEventListener('mousemove', move);
        el.addEventListener('touchstart', down, {passive:false}); window.addEventListener('touchend', up); window.addEventListener('touchmove', move, {passive:false});
      }
      drag(startThumb, onMoveStart);
      drag(endThumb, onMoveEnd);

      rail.addEventListener('click', (e)=>{
        const { x } = railMetrics();
        const px = e.clientX - x;
        let k = pxToNearestBand(px);
        if (k === 0) state.band = 0;
        else state.band = clampBand(k - 1);
        update();
      });
    }

    // Draw discount chart with exactly 5 bars: T, 2T, 3T, 4T, 5T
    function drawDiscountChart(){
      const canvas = document.getElementById('discountChart');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
      const w = canvas.width, h = canvas.height, pad = 46, cw = w - pad*2, ch = h - pad*2;

      const steps = [0,1,2,3,4]; // five finite bands
      const discounts = steps.map(s => CONFIG.BASE_MAX_SHARE_PCT - bandPercent(s, state.inv));
      const maxDisc = Math.max(10, ...discounts);
      chartBarRects = [];

      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();

      const barW = cw / steps.length * 0.7;
      steps.forEach((s,i)=>{
        const x = pad + (i + 0.15) * (cw / steps.length);
        const val = discounts[i];
        const bh = (val / maxDisc) * ch;
        ctx.fillStyle = '#ffd166';
        ctx.fillRect(x, h - pad - bh, barW, bh);
        chartBarRects.push({x, y:h - pad - bh, w:barW, h:bh, step:s});

        // x labels: T, 2T, 3T, 4T, 5T
        const endRevenue = (s + 1) * state.T;
        const lbl = humanShort(endRevenue);
        ctx.fillStyle = '#cbd2e9'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(lbl, x + barW/2, h - pad + 16);

        // highlight current
        if (s === state.band){
          ctx.strokeStyle = '#7aa2ff'; ctx.lineWidth = 2;
          ctx.strokeRect(x-2, h - pad - bh - 2, barW+4, bh+4);
        }
      });

      // y labels as percentages
      ctx.fillStyle = '#9aa3bd'; ctx.font = '12px sans-serif'; ctx.textAlign = 'right';
      for (let i=0;i<=4;i++){
        const y = h - pad - (i/4)*ch;
        const v = (i/4)*maxDisc;
        ctx.fillText(`${Math.round(v)}%`, pad - 8, y + 4);
      }
      ctx.fillStyle = '#9aa3bd'; ctx.textAlign = 'left'; ctx.fillText('Discount (%) from 50%', pad, pad - 12);

      canvas.onclick = (evt)=>{
        const rect = canvas.getBoundingClientRect();
        const cx = evt.clientX - rect.left;
        const cy = evt.clientY - rect.top;
        for (let i=0;i<chartBarRects.length;i++){
          const r = chartBarRects[i];
          if (cx >= r.x && cx <= r.x + r.w && cy >= r.y && cy <= r.y + r.h){
            state.band = r.step;
            update();
            const tr = document.querySelector(`tr[data-step="${r.step}"]`);
            if (tr) tr.scrollIntoView({behavior:'smooth', block:'nearest'});
            break;
          }
        }
      };
    }

    function updateTable(){
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      const inventoryCols = [25, 50, 75, 100];
      for (let s = 0; s < CONFIG.BANDS; s++){
        const row = document.createElement('tr');
        row.dataset.step = String(s);
        if (s === state.band) row.className = 'highlight';
        const bandCell = document.createElement('td');
        bandCell.textContent = bandLabel(s, state.T);
        row.appendChild(bandCell);
        for (const icp of inventoryCols){
          const finalPct = bandPercent(s, icp);
          const cell = document.createElement('td');
          cell.textContent = finalPct.toFixed(2) + '%';
          row.appendChild(cell);
        }
        row.addEventListener('click', () => {
          state.band = s;
          update();
        });
        tbody.appendChild(row);
      }
    }

    function updateNumbers(){
      // Per-step (marginal) amounts: width = T
      const pct = bandPercent(state.band, state.inv);
      const your = state.T * (pct / 100);
      const client = state.T - your;
      document.getElementById('yourValue').textContent = fmt(your);
      document.getElementById('clientValue').textContent = fmt(client);

      const yPct = Math.round(pct);
      const cPct = Math.max(0, 100 - yPct);
      document.getElementById('yourBar').style.width = `${yPct}%`;
      document.getElementById('yourBar').textContent = `Your ${yPct}%`;
      document.getElementById('clientBar').textContent = `Client ${cPct}%`;
    }

    // Accumulated totals up to selected band (inclusive)
    function updateAccumTotals(){
      const bandsCount = state.band + 1; // inclusive
      const gross = bandsCount * state.T;
      let platform = 0;
      for (let s = 0; s <= state.band; s++){
        const pct = bandPercent(s, state.inv);
        platform += state.T * (pct / 100);
      }
      const client = gross - platform;
      const eff = gross > 0 ? (platform / gross) * 100 : 0;
      document.getElementById('accGross').textContent = fmt(gross);
      document.getElementById('accYour').textContent  = fmt(platform);
      document.getElementById('accClient').textContent= fmt(client);
      document.getElementById('accEff').textContent   = `${eff.toFixed(2)}%`;
    }

    function update(){
      state.inv = parseInt(document.getElementById('invSlider').value, 10);
      document.getElementById('invDisplay').textContent = state.inv;
      document.getElementById('bandWidth').textContent = fmt(state.T);
      document.getElementById('noticeBox').innerHTML =
        `<strong>Per-step mode:</strong> The values on the right are for the selected band only. The totals below reflect <em>accumulated</em> shares up to this band.`;

      positionHandles();
      updateNumbers();
      updateTable();
      drawDiscountChart();
      updateAccumTotals();
    }

    function onTargetFocus(){ const el = document.getElementById('target'); el.value = onlyDigits(el.value); }
    function onTargetChangeManual(){ const t = document.getElementById('target'); state.T = formatCurrencyInput(t); update(); }

    window.addEventListener('DOMContentLoaded', () => {
      const t = document.getElementById('target');
      t.addEventListener('focus', onTargetFocus);
      t.addEventListener('blur', onTargetChangeManual);
      t.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { onTargetChangeManual(); t.blur(); } });
      t.value = '$' + state.T.toLocaleString();
      document.getElementById('invSlider').addEventListener('input', update);
      setupTicks(); enableDragging(); update();
    });
    window.addEventListener('resize', () => { update(); });
  </script>
</body>
</html>
