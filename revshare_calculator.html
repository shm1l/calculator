<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accelerated Revenue Share Calculator (Single File)</title>
  <style>
    :root {
      --bg:#0f1220; --panel:#171a2b; --muted:#8a93a6; --text:#e8ecf8; --accent:#7aa2ff;
      --green:#5fd08b; --yellow:#ffd166; --red:#ff6b6b; --purple:#b388ff;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; padding:24px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, #1d2342 0%, #0f1220 60%);
      color: var(--text);
    }
    h1 { margin: 0 0 8px; font-weight: 700; letter-spacing: 0.2px; }
    .sub { color: var(--muted); margin-bottom: 24px; }
    .wrap {
      display:grid; grid-template-columns: 360px 1fr; gap: 20px; align-items:start;
    }
    .card { background: linear-gradient(180deg,#1a2040, #151a30); border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .stack { display:flex; flex-direction:column; gap: 12px; }
    .row { display:grid; grid-template-columns: 1fr 140px; gap: 10px; align-items:center; }
    .row label { color: var(--muted); font-size: 13px; }
    input[type="number"]{
      width: 100%; padding: 10px 12px; border-radius: 10px; background: #0e1325; color: var(--text);
      border: 1px solid rgba(255,255,255,.08); outline: none;
    }
    input[type="range"]{ width: 100%; }
    .slider-row { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#0e1325; border:1px solid rgba(255,255,255,.07); font-size:12px; color: var(--muted); }
    .grid { width: 100%; border-collapse: collapse; }
    .grid th, .grid td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,.06); font-size: 13px; }
    .grid th { text-align:left; color: var(--muted); font-weight: 600; }
    .grid tr.highlight { background: rgba(122,162,255,.08); }
    .bar {
      display:flex; height: 28px; overflow:hidden; border-radius: 999px; background: #0e1325; border:1px solid rgba(255,255,255,.06);
    }
    .bar .your { background: var(--purple); display:flex; align-items:center; justify-content:center; font-size:12px; }
    .bar .client { background: var(--green); display:flex; align-items:center; justify-content:center; font-size:12px; flex:1; }
    canvas { width: 100%; height: 240px; background:#0f1328; border-radius: 12px; border:1px solid rgba(255,255,255,.06); }
    .muted { color: var(--muted); }
    .ok { color: var(--green); }
    .fail { color: var(--red); }
    .btn { cursor:pointer; background: var(--accent); border:none; color:#0b1022; padding: 10px 14px; border-radius: 10px; font-weight: 700; }
    .note { font-size: 12px; color: var(--muted); }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Accelerated Revenue Share Calculator</h1>
  <div class="sub">Python model → JavaScript, single-file. Define inputs and compute platform & customer shares with accelerated bands.</div>

  <div class="wrap">
    <!-- LEFT: Inputs -->
    <div class="card stack">
      <div class="row">
        <label for="target">Target Annual Revenue (band size, T)</label>
        <input id="target" type="number" step="1000" value="200000" min="1000">
      </div>
      <div class="row">
        <label for="gross">Gross Revenue</label>
        <input id="gross" type="number" step="1000" value="350000" min="0">
      </div>
      <div class="stack">
        <div class="slider-row">
          <label for="invSlider" id="invLabel">Inventory Exposure (%) — Allowed: 25%–100%</label>
          <span class="badge"><span id="invDisplay">75</span>%</span>
        </div>
        <input id="invSlider" type="range" min="25" max="100" step="1" value="75" oninput="syncInvFromSlider(this.value)">
        <input id="inv" type="number" min="25" max="100" step="1" value="75" oninput="syncInvFromBox(this.value)">
      </div>

      <button class="btn" onclick="update()">Recalculate</button>

      <div class="note" id="noticeBox"></div>
    </div>

    <!-- RIGHT: Results -->
    <div class="card stack">
      <div class="row">
        <div>
          <div class="muted">Gross Revenue</div>
          <div id="dispTotal" style="font-size:22px; font-weight:800;">$0</div>
        </div>
        <div>
          <div class="muted">Split (Your% / Client%)</div>
          <div id="dispSplit" style="font-size:22px; font-weight:800;">0% / 0%</div>
        </div>
      </div>
      <div class="bar">
        <div id="yourBar" class="your" style="width:0%;">Your 0%</div>
        <div id="clientBar" class="client">Client 100%</div>
      </div>
      <div class="row">
        <div>
          <div class="muted">Your Share</div>
          <div id="yourValue" style="font-size:20px; font-weight:700;">$0</div>
        </div>
        <div>
          <div class="muted">Client Share</div>
          <div id="clientValue" style="font-size:20px; font-weight:700;">$0</div>
        </div>
      </div>
      <canvas id="revenueChart" width="900" height="240"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card" style="margin-top:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div class="muted">Accelerated Revenue Share Table (rows=bands relative to T; columns=inventory)</div>
      <div class="badge">T defines band size</div>
    </div>
    <table class="grid" id="lookup">
      <thead>
        <tr>
          <th>Revenue Band (by T)</th>
          <th>25%</th><th>50%</th><th>75%</th><th>100%</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    // ===== CONFIG from Python =====
    const CONFIG = {
      STEP_COUNT_ABOVE_THRESHOLD: 5,
      MIN_INVENTORY_PCT: 25,
      MAX_INVENTORY_PCT: 100,
      BASE_MAX_SHARE_PCT: 50,
      PER_STEP_BASE: 1.0,
      BAND_ACCEL: 0.25,
      INV_ACCEL: 1.25,
      INVENTORY_DENOM: 130
    };
    const clamp = (v, lo, hi) => Math.min(Math.max(v, lo), hi);

    function validateInventory(icp, cfg = CONFIG) {
      if (icp < cfg.MIN_INVENTORY_PCT || icp > cfg.MAX_INVENTORY_PCT) {
        throw new Error(`Inventory must be between ${cfg.MIN_INVENTORY_PCT}% and ${cfg.MAX_INVENTORY_PCT}%. Got ${icp}%.`);
      }
    }
    function revenueStepPoints(grossRevenue, T) {
      if (grossRevenue <= T) return 0;
      const delta = grossRevenue - T;
      return Math.ceil(delta / T);
    }
    function totalStepReduction(step, icp, cfg = CONFIG) {
      const invScale = clamp((icp - cfg.MIN_INVENTORY_PCT) / (cfg.MAX_INVENTORY_PCT - cfg.MIN_INVENTORY_PCT), 0, 1);
      const bandTerm = cfg.PER_STEP_BASE * (1 + cfg.BAND_ACCEL * Math.max(step - 1, 0));
      return step * bandTerm * (1 + cfg.INV_ACCEL * invScale);
    }
    function platformPercent(grossRevenue, inventoryPct, T, cfg = CONFIG) {
      validateInventory(inventoryPct, cfg);
      const step = revenueStepPoints(grossRevenue, T);
      const preInventoryPct = Math.max(0, cfg.BASE_MAX_SHARE_PCT - totalStepReduction(step, inventoryPct, cfg));
      const multiplier = Math.max(0, 1 - inventoryPct / cfg.INVENTORY_DENOM);
      return Math.max(0, preInventoryPct * multiplier);
    }
    function splitAmounts(grossRevenue, inventoryPct, T, cfg = CONFIG) {
      const pct = platformPercent(grossRevenue, inventoryPct, T, cfg);
      const platform_amount = grossRevenue * (pct / 100);
      const customer_amount = grossRevenue - platform_amount;
      return { pct, platform_amount, customer_amount };
    }
    function bandLabel(step, T, includePlusRow = true, cfg = CONFIG) {
      if (step === 0) return `≤ $${T.toLocaleString()}`;
      const lo = T + (step - 1) * T + 1;
      const hi = T + step * T;
      if (includePlusRow && step === cfg.STEP_COUNT_ABOVE_THRESHOLD) return `$${lo.toLocaleString()}+`;
      return `$${lo.toLocaleString()} – $${hi.toLocaleString()}`;
    }

    // ===== UI glue =====
    function fmt(n){ return '$' + Math.round(n).toLocaleString(); }
    function syncInvFromSlider(v){ document.getElementById('inv').value = v; document.getElementById('invDisplay').textContent = v; update(); }
    function syncInvFromBox(v){
      const iv = Math.min(Math.max(parseInt(v||0,10), CONFIG.MIN_INVENTORY_PCT), CONFIG.MAX_INVENTORY_PCT);
      document.getElementById('inv').value = iv;
      document.getElementById('invSlider').value = iv;
      document.getElementById('invDisplay').textContent = iv;
      update();
    }

    function drawChart_PythonModel(T, currentInv) {
      const canvas = document.getElementById('revenueChart');
      const ctx = canvas.getContext('2d');
      const gross = parseFloat(document.getElementById('gross').value) || 0;

      canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
      const w = canvas.width, h = canvas.height, pad = 40, cw = w - pad*2, ch = h - pad*2;

      // We'll vary inventory from 25%..100% and plot your & client amounts
      let maxVal = 0;
      for (let inv = CONFIG.MIN_INVENTORY_PCT; inv <= 100; inv += 5) {
        const res = splitAmounts(gross, inv, T);
        maxVal = Math.max(maxVal, res.platform_amount, res.customer_amount);
      }

      ctx.clearRect(0,0,w,h);
      // axes
      ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();

      // grid
      ctx.strokeStyle = 'rgba(255,255,255,.08)';
      for (let i=0;i<=5;i++){
        const y = pad + (ch/5)*i;
        ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
      }

      const xForInv = inv => pad + ((inv - CONFIG.MIN_INVENTORY_PCT) / (100 - CONFIG.MIN_INVENTORY_PCT)) * cw;
      const yForVal = v => h - pad - (v / maxVal) * ch;

      // platform line
      ctx.beginPath(); ctx.lineWidth = 2; ctx.strokeStyle = '#b388ff';
      let first = true;
      for (let inv = CONFIG.MIN_INVENTORY_PCT; inv <= 100; inv += 5) {
        const res = splitAmounts(gross, inv, T);
        const x = xForInv(inv), y = yForVal(res.platform_amount);
        if(first){ ctx.moveTo(x,y); first=false;} else { ctx.lineTo(x,y); }
      }
      ctx.stroke();

      // client line
      ctx.beginPath(); ctx.lineWidth = 2; ctx.strokeStyle = '#5fd08b'; first = true;
      for (let inv = CONFIG.MIN_INVENTORY_PCT; inv <= 100; inv += 5) {
        const res = splitAmounts(gross, inv, T);
        const x = xForInv(inv), y = yForVal(res.customer_amount);
        if(first){ ctx.moveTo(x,y); first=false;} else { ctx.lineTo(x,y); }
      }
      ctx.stroke();

      // guideline for currentInv
      const currX = xForInv(currentInv);
      ctx.setLineDash([6,6]); ctx.strokeStyle = '#7aa2ff';
      ctx.beginPath(); ctx.moveTo(currX,pad); ctx.lineTo(currX,h-pad); ctx.stroke();
      ctx.setLineDash([]);
    }

    function update(){
      const T = Math.max(1, parseFloat(document.getElementById('target').value) || 200000);
      let inv = parseInt(document.getElementById('inv').value) || 75;
      inv = Math.min(Math.max(inv, CONFIG.MIN_INVENTORY_PCT), CONFIG.MAX_INVENTORY_PCT);
      document.getElementById('inv').value = inv;
      document.getElementById('invSlider').value = inv;
      document.getElementById('invDisplay').textContent = inv;

      const gross = parseFloat(document.getElementById('gross').value) || 0;

      document.getElementById('invLabel').textContent = `Inventory Exposure (%) — Allowed: ${CONFIG.MIN_INVENTORY_PCT}%–${CONFIG.MAX_INVENTORY_PCT}%`;
      document.getElementById('noticeBox').innerHTML = [
        `<strong>Model:</strong> Base 50% → minus band+inventory reduction → inventory multiplier (1 - ICP / ${CONFIG.INVENTORY_DENOM})`,
        `Bands are sized by <em>T</em> = $${T.toLocaleString()} (Target Annual Revenue); 5 steps above the base row.`
      ].join('<br>');

      const res = splitAmounts(gross, inv, T);
      const yPct = Math.round(res.pct);
      const cPct = Math.max(0, 100 - yPct);

      document.getElementById('dispTotal').textContent = '$' + Math.round(gross).toLocaleString();
      document.getElementById('dispSplit').textContent = `${yPct}% / ${cPct}%`;
      document.getElementById('yourValue').textContent = fmt(res.platform_amount);
      document.getElementById('clientValue').textContent = fmt(res.customer_amount);

      const yourBar = document.getElementById('yourBar');
      const clientBar = document.getElementById('clientBar');
      yourBar.style.width = `${yPct}%`; yourBar.textContent = `Your ${yPct}%`; clientBar.textContent = `Client ${cPct}%`;

      // Table
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      const inventoryCols = [25, 50, 75, 100];
      for (let s = 0; s <= CONFIG.STEP_COUNT_ABOVE_THRESHOLD; s++){
        const row = document.createElement('tr');
        const bandCell = document.createElement('td');
        bandCell.textContent = bandLabel(s, T, true);
        row.appendChild(bandCell);
        for (const icp of inventoryCols){
          const stepGross = s === 0 ? T : (T + s*T); // a representative gross inside the band
          const pre = Math.max(0, CONFIG.BASE_MAX_SHARE_PCT - totalStepReduction(s, icp, CONFIG));
          const finalPct = Math.max(0, pre * Math.max(0, 1 - icp / CONFIG.INVENTORY_DENOM));
          const cell = document.createElement('td');
          cell.textContent = finalPct.toFixed(2) + '%';
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      }

      // Chart
      drawChart_PythonModel(T, inv);
    }

    // ===== Self-tests =====
    function almostEqual(a,b,eps=1e-6){ return Math.abs(a-b) <= eps; }
    function addTestLine(msg, ok){
      const li = document.createElement('li');
      li.textContent = (ok ? '✓ ' : '✗ ') + msg;
      li.className = ok ? 'ok' : 'fail';
      document.getElementById('testOutput').appendChild(li);
    }
    function runSelfTests(){
      document.getElementById('testOutput').innerHTML = '';
      const status = document.getElementById('testStatus');
      status.textContent = 'Running…';

      // Known Python result for T=200000, gross=350000, inv=75
      const expectedPct = 20.37820512820513;
      const expectedYour = 71323.71794871797;
      const expectedClient = 278676.282051282;

      const T = 200000, gross = 350000, icp = 75;
      const res = splitAmounts(gross, icp, T);

      addTestLine(`pct ≈ ${expectedPct.toFixed(10)} (got ${res.pct.toFixed(10)})`, almostEqual(res.pct, expectedPct, 1e-9));
      addTestLine(`your ≈ ${expectedYour.toFixed(4)} (got ${res.platform_amount.toFixed(4)})`, almostEqual(res.platform_amount, expectedYour, 1e-6));
      addTestLine(`client ≈ ${expectedClient.toFixed(4)} (got ${res.customer_amount.toFixed(4)})`, almostEqual(res.customer_amount, expectedClient, 1e-6));

      // Quick bounds tests for inventory
      let threwLow=false, threwHigh=false;
      try{ platformPercent(100000, 10, 200000); } catch(e){ threwLow=true; }
      try{ platformPercent(100000, 150, 200000); } catch(e){ threwHigh=true; }
      addTestLine('rejects inventory below 25%', threwLow);
      addTestLine('rejects inventory above 100%', threwHigh);

      status.textContent = 'Done';
    }

    // boot
    window.addEventListener('DOMContentLoaded', () => { update(); runSelfTests(); });
  </script>
</body>
</html>
